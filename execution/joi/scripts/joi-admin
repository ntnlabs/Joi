#!/bin/bash
# Joi Admin Tool - Memory and key management
#
# Usage: sudo joi-admin purge [FLAGS]
#
# SAFE BY DEFAULT: No flags = no action. Must explicitly specify what to purge.

set -euo pipefail

SCRIPT_NAME=$(basename "$0")
MEMORY_DB="${JOI_MEMORY_DB:-/var/lib/joi/memory.db}"
NONCE_DB="${JOI_NONCE_DB:-/var/lib/joi/nonces.db}"
HMAC_KEY_FILE="${JOI_HMAC_KEY_FILE:-/etc/joi/hmac.key}"
NEBULA_DIR="/etc/nebula"
SERVICE_USER="${JOI_SERVICE_USER:-joi}"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

usage() {
    cat << 'EOF'
Joi Admin Tool

USAGE:
    joi-admin <COMMAND> [OPTIONS]

COMMANDS:
    purge       Purge memory data and/or regenerate keys

PURGE USAGE:
    joi-admin purge [FLAGS]

    SAFE BY DEFAULT: Running without flags does nothing.

DATA FLAGS (what to delete):
    --contexts          Delete messages and context summaries
    --facts             Delete learned user facts
    --knowledge         Delete RAG knowledge chunks
    --all-data          All of the above (contexts + facts + knowledge)

SCOPE FLAGS (limit deletion):
    --conversation ID   Only affect specific conversation (phone/group ID)
                        Without this, affects ALL conversations

KEY FLAGS:
    --hmac-key          Regenerate HMAC signing key
    --nebula-keys       Remove Nebula host keys (requires re-enrollment)
    --all-keys          Both HMAC and Nebula keys

NUCLEAR OPTIONS:
    --everything        Equivalent to --all-data --all-keys
    --nebula-ca         Also remove Nebula CA cert (true factory reset)

EXAMPLES:
    joi-admin purge                                    # Does nothing (safe)
    joi-admin purge --contexts                         # Clear all conversation history
    joi-admin purge --contexts --conversation +1234    # Clear one conversation (//reload)
    joi-admin purge --contexts --facts --conversation +1234  # //restart equivalent
    joi-admin purge --all-data --conversation +1234    # //reset equivalent
    joi-admin purge --all-data --all-keys              # Customer handoff
    joi-admin purge --everything --nebula-ca           # True factory reset

EOF
    exit 0
}

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}Warning: $1${NC}" >&2
}

info() {
    echo -e "${GREEN}$1${NC}"
}

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "This script must be run as root (sudo)"
    fi
}

# Purge messages and summaries
purge_contexts() {
    local conversation="$1"
    local count=0

    if [[ ! -f "$MEMORY_DB" ]]; then
        warn "Memory database not found: $MEMORY_DB"
        return
    fi

    if [[ -n "$conversation" ]]; then
        echo "Purging contexts for conversation: $conversation"
        count=$(sqlite3 "$MEMORY_DB" "SELECT COUNT(*) FROM messages WHERE conversation_id = '$conversation';")
        sqlite3 "$MEMORY_DB" "DELETE FROM messages WHERE conversation_id = '$conversation';"
        sqlite3 "$MEMORY_DB" "DELETE FROM context_summaries WHERE conversation_id = '$conversation';"
    else
        echo "Purging ALL contexts"
        count=$(sqlite3 "$MEMORY_DB" "SELECT COUNT(*) FROM messages;")
        sqlite3 "$MEMORY_DB" "DELETE FROM messages;"
        sqlite3 "$MEMORY_DB" "DELETE FROM context_summaries;"
    fi

    info "  Deleted $count messages"
}

# Purge user facts
purge_facts() {
    local conversation="$1"
    local count=0

    if [[ ! -f "$MEMORY_DB" ]]; then
        warn "Memory database not found: $MEMORY_DB"
        return
    fi

    if [[ -n "$conversation" ]]; then
        echo "Purging facts for conversation: $conversation"
        count=$(sqlite3 "$MEMORY_DB" "SELECT COUNT(*) FROM user_facts WHERE conversation_id = '$conversation';")
        sqlite3 "$MEMORY_DB" "DELETE FROM user_facts WHERE conversation_id = '$conversation';"
    else
        echo "Purging ALL facts"
        count=$(sqlite3 "$MEMORY_DB" "SELECT COUNT(*) FROM user_facts;")
        sqlite3 "$MEMORY_DB" "DELETE FROM user_facts;"
    fi

    info "  Deleted $count facts"
}

# Purge knowledge chunks
purge_knowledge() {
    local count=0

    if [[ ! -f "$MEMORY_DB" ]]; then
        warn "Memory database not found: $MEMORY_DB"
        return
    fi

    echo "Purging knowledge chunks"
    count=$(sqlite3 "$MEMORY_DB" "SELECT COUNT(*) FROM knowledge_chunks;")
    sqlite3 "$MEMORY_DB" "DELETE FROM knowledge_chunks;"
    # Also clear FTS index if it exists
    sqlite3 "$MEMORY_DB" "DELETE FROM knowledge_fts;" 2>/dev/null || true

    info "  Deleted $count knowledge chunks"
}

# Purge nonce database
purge_nonces() {
    if [[ -f "$NONCE_DB" ]]; then
        echo "Purging nonce database"
        rm -f "$NONCE_DB"
        info "  Deleted $NONCE_DB"
    fi
}

# Regenerate HMAC key
regenerate_hmac() {
    echo "Regenerating HMAC key"

    local key_dir
    key_dir=$(dirname "$HMAC_KEY_FILE")

    if [[ ! -d "$key_dir" ]]; then
        mkdir -p "$key_dir"
        chown "$SERVICE_USER:$SERVICE_USER" "$key_dir"
        chmod 700 "$key_dir"
    fi

    # Generate new key
    local new_key
    new_key=$(openssl rand -hex 32)

    umask 077
    echo "$new_key" > "$HMAC_KEY_FILE"
    chmod 600 "$HMAC_KEY_FILE"
    chown "$SERVICE_USER:$SERVICE_USER" "$HMAC_KEY_FILE"

    # Also purge nonces since old signatures are invalid
    purge_nonces

    info "  New HMAC key written to $HMAC_KEY_FILE"
    warn "  Mesh VM must also update its HMAC key to match!"
}

# Remove Nebula host keys
purge_nebula_keys() {
    echo "Removing Nebula host keys"

    local removed=0
    for f in "$NEBULA_DIR"/host.key "$NEBULA_DIR"/host.crt; do
        if [[ -f "$f" ]]; then
            rm -f "$f"
            info "  Deleted $f"
            ((removed++))
        fi
    done

    if [[ $removed -eq 0 ]]; then
        warn "  No Nebula host keys found"
    else
        warn "  Host must be re-enrolled with Nebula CA"
    fi
}

# Remove Nebula CA (factory reset)
purge_nebula_ca() {
    echo "Removing Nebula CA certificate"

    if [[ -f "$NEBULA_DIR/ca.crt" ]]; then
        rm -f "$NEBULA_DIR/ca.crt"
        info "  Deleted $NEBULA_DIR/ca.crt"
        warn "  Complete Nebula re-setup required!"
    else
        warn "  No Nebula CA found"
    fi
}

# Reset system state
reset_system_state() {
    if [[ ! -f "$MEMORY_DB" ]]; then
        return
    fi

    echo "Resetting system state"
    sqlite3 "$MEMORY_DB" << 'SQL'
UPDATE system_state SET value = '0' WHERE key IN (
    'last_interaction_at',
    'last_impulse_check_at',
    'messages_sent_this_hour',
    'messages_sent_hour_start',
    'last_context_cleanup_at',
    'last_memory_consolidation_at'
);
UPDATE system_state SET value = '' WHERE key = 'current_conversation_topic';
UPDATE system_state SET value = '"idle"' WHERE key = 'agent_state';
SQL
    info "  System state reset"
}

# Main purge command
cmd_purge() {
    local do_contexts=false
    local do_facts=false
    local do_knowledge=false
    local do_hmac=false
    local do_nebula_keys=false
    local do_nebula_ca=false
    local conversation=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --contexts)
                do_contexts=true
                shift
                ;;
            --facts)
                do_facts=true
                shift
                ;;
            --knowledge)
                do_knowledge=true
                shift
                ;;
            --all-data)
                do_contexts=true
                do_facts=true
                do_knowledge=true
                shift
                ;;
            --conversation)
                [[ -z "${2:-}" ]] && error "--conversation requires an ID"
                conversation="$2"
                shift 2
                ;;
            --hmac-key)
                do_hmac=true
                shift
                ;;
            --nebula-keys)
                do_nebula_keys=true
                shift
                ;;
            --all-keys)
                do_hmac=true
                do_nebula_keys=true
                shift
                ;;
            --everything)
                do_contexts=true
                do_facts=true
                do_knowledge=true
                do_hmac=true
                do_nebula_keys=true
                shift
                ;;
            --nebula-ca)
                do_nebula_ca=true
                shift
                ;;
            --help|-h)
                usage
                ;;
            *)
                error "Unknown option: $1"
                ;;
        esac
    done

    # Check if anything to do
    if ! $do_contexts && ! $do_facts && ! $do_knowledge && ! $do_hmac && ! $do_nebula_keys && ! $do_nebula_ca; then
        echo "No purge flags specified. Nothing to do."
        echo ""
        echo "Run 'joi-admin purge --help' for usage."
        exit 0
    fi

    # Safety check for nuclear options
    if $do_nebula_ca && ! $do_nebula_keys; then
        error "--nebula-ca requires --nebula-keys or --everything"
    fi

    # Confirm destructive action
    echo ""
    echo "=== PURGE SUMMARY ==="
    $do_contexts && echo "  - Contexts (messages, summaries)"
    $do_facts && echo "  - User facts"
    $do_knowledge && echo "  - Knowledge chunks"
    $do_hmac && echo "  - HMAC key (regenerate)"
    $do_nebula_keys && echo "  - Nebula host keys"
    $do_nebula_ca && echo "  - Nebula CA certificate"
    [[ -n "$conversation" ]] && echo "  Scope: conversation $conversation" || echo "  Scope: ALL"
    echo ""

    read -p "Are you sure? This cannot be undone. [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 1
    fi

    echo ""
    echo "=== PURGING ==="

    # Execute purges
    $do_contexts && purge_contexts "$conversation"
    $do_facts && purge_facts "$conversation"
    $do_knowledge && purge_knowledge

    # Reset system state if purging all data
    if $do_contexts && $do_facts && [[ -z "$conversation" ]]; then
        reset_system_state
    fi

    $do_hmac && regenerate_hmac
    $do_nebula_keys && purge_nebula_keys
    $do_nebula_ca && purge_nebula_ca

    echo ""
    info "=== PURGE COMPLETE ==="

    # Reminders
    if $do_hmac; then
        echo ""
        warn "REMINDER: Update HMAC key on Mesh VM to match!"
    fi

    if $do_nebula_keys || $do_nebula_ca; then
        echo ""
        warn "REMINDER: Nebula re-enrollment required before network connectivity!"
    fi
}

# Main entry point
main() {
    if [[ $# -lt 1 ]]; then
        usage
    fi

    local command="$1"
    shift

    case "$command" in
        purge)
            check_root
            cmd_purge "$@"
            ;;
        --help|-h)
            usage
            ;;
        *)
            error "Unknown command: $command. Run '$SCRIPT_NAME --help' for usage."
            ;;
    esac
}

main "$@"
